# Day 26 — Merge 우선순위 규칙 적용 & 2성→3성 합성 안정화 (Step 1)

## ✅ 오늘의 목표
1) **2성 → 3성 합성이 안 되는 문제**를 해결합니다.  
   - “유닛이 구매/생성될 때마다 자동으로 Merge 체크 → IncreaseStar → 다시 Merge 체크(연쇄 가능)” 흐름을 유지합니다.

2) 합성 결과 유닛의 **위치(keep) 우선순위**를 명확히 정의하고 그대로 동작하게 만듭니다.

---

## 🧪 교차검증 체크리스트 (필수 3개)
Step 완료 후 아래 3개는 꼭 확인합니다.

1) 이동이 스르륵 자연스럽게 유지되는지  
2) 공격이 사거리에서 멈추지 않고 정상 발동하는지(공격 쿨다운 바 포함)  
3) 라운드 종료/보상/정리/다음 라운드 로그가 1회씩만 나오는지  
- `Result / Income / RoundEnd Cleanup / Prepare Round` 중복 여부 확인

---

## 🎯 요구사항: 합성 결과 위치 우선순위
합성될 때 남는 유닛(keep) 위치는 다음 우선순위를 따릅니다.

1) **벤치 & 보드 전체에서 합성이 발생하면 → 결과는 보드에 배치**
2) **보드에서만 합성되면 → 보드에서 가장 오래된(먼저 생성된) 자리 유지**
3) **벤치에서만 합성되면 → 합성에 사용된 벤치 슬롯 중 가장 앞 슬롯(예: 1,2,3이면 1번)**

---

## Step 1: keep(남길 유닛) 선정 규칙을 코드에 반영

### ✅ 무엇을 바꾸는지
- 기존: `keep = spawned` (마지막 생성/구매 유닛이 keep이 되는 경향)
- 변경: 후보 3개 중 **우선순위 규칙으로 keep을 선택**하도록 수정

### ✅ 왜 바꾸는지
- 합성 결과가 “마지막 위치”로 튀는 문제를 방지하고,
- TFT처럼 “보드 우선 / 오래된 자리 유지 / 벤치면 앞 슬롯 유지”로 UX를 고정합니다.

### ✅ 바꾸면 막히는 버그
- 합성 결과가 벤치에 남거나, 보드에서 튀는 현상
- 보드에 여러 개 있는데도 마지막 구매 유닛 자리로 결과가 가는 현상
- 벤치 합성 결과가 랜덤 슬롯에 남는 현상

---

## ✅ 적용한 최소 수정 포인트 요약

### 1) GridManager에 생성 순서 기록(보드에서 가장 오래된 유닛 판정용)
- `spawnSeq` 딕셔너리 + `nextSpawnSeq` 카운터를 추가
- 유닛이 생성/구매될 때마다 `RegisterSpawnSeq(unit)` 호출

### 2) keep 선정 함수 추가
- 후보 3개를 보고,
  - 보드에 있는 유닛 중 가장 오래된(seq 가장 작은) 유닛 우선
  - 보드가 없으면 벤치 슬롯 index가 가장 작은 유닛 우선
  - 그래도 없으면 첫 번째 fallback

### 3) TryMergeAfterSpawn에서 keep = spawned 를 keep = PickKeepByPriority 로 교체
- remove1/remove2 선택 로직은 그대로 두고 keep만 바꿈 (갈아엎기 X)

---

## ✅ 테스트 시나리오 (기능 검증)

### 케이스 A — 벤치에서만 합성(1→2, 2→3 모두)
1) 벤치 1,2,3 슬롯에 같은 1성 유닛 배치
2) 합성 발생 후 **1번 슬롯에 2성** 남는지 확인
3) 동일 방식으로 2성 3개 만들고 3성으로 합성 → **1번 슬롯에 3성** 남는지 확인

### 케이스 B — 보드+벤치 혼합 합성
1) 보드에 동일 1성 2개 배치
2) 벤치에 동일 1성 1개 배치
3) 합성 발생 시 **무조건 보드에 남는지** 확인

### 케이스 C — 보드에서만 합성(오래된 자리 유지)
1) 보드에 동일 1성 3개 배치하되, 생성 시점을 다르게(1→2→3 순서로 생성)
2) 합성 결과가 **가장 먼저 생성된 유닛 자리**에 남는지 확인

---

## 📌 오늘 결과(정리)
- 2성 → 3성 합성 실패 문제를 “구매/생성 시 자동 merge 체크 + 연쇄 merge 가능” 구조로 안정화할 준비를 마쳤습니다.
- 합성 결과 위치가 **보드 우선 / 오래된 자리 유지 / 벤치면 앞 슬롯 유지**로 고정되도록 규칙을 정리했고,
  해당 규칙을 코드 수준에서 적용하는 Step 1을 진행했습니다.

---

## Next (예고)
- Step 2: 벤치+보드 전체를 대상으로 하는 Merge 스캔을 “단 1곳(중앙 Merge 처리 함수)”로 정리  
- Step 3: Merge 후 제거되는 유닛의 **Tile/Bench 참조 유령 포인터**가 남지 않도록 정리 로직 교차검증 강화  
- Step 4: 합성 연출(간단한 이펙트/사운드) + UI 갱신 타이밍 통합

