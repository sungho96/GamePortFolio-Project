---
title: "Day 27 - Bench 이동 제한(Setup 전용) + Battle→Setup 루틴 점검"
date: "2026-01-09"
tags: [Unity, C#, TFT, AutoBattle, Shop, Bench, Drag]
---

## 오늘의 목표
1) **벤치 유닛은 `BattleState.Setup`일 때만 이동/드롭이 가능**하도록 동작 기준 정리  
2) **전투 시작(Battle) → 종료(End) → 다시 Setup 복귀 루틴**이 실제로 존재하는지/어떻게 동작하는지 재확인  
3) (코드 수정 최소) 오늘은 “버그 원인 파악 + 체크리스트 확정”에 집중

---

## 현재 상황 요약
- Shop/Bench 기본 동작은 정상(구매, 벤치 배치, 스탯/튜닝 적용 등 완료)
- `InBattle` 플래그로 **벤치 유닛이 전투에 참여하지 않도록** 하는 구조를 도입/활용 중
- 다만 **“벤치 이동은 Setup에서만 가능해야 하는데 동작이 이상함”** 증상이 있음

---

## 핵심 개념 정리 (코드 말고 로직 기준)
### 1) Bench 이동 제한의 본질
- “벤치 ↔ 보드 이동” 자체는 입력(드래그/클릭)에 의해 발생
- 전투 중(Battle)에도 입력이 살아있으면:
  - 전투 중에 유닛 위치가 바뀌거나
  - 벤치 유닛이 전투 참여 플래그(`InBattle`)가 켜진 채로 공격을 시도하거나
  - 보드 유닛이 반대로 `InBattle=false`로 남아 전투에 참여하지 않는 등
  **상태 불일치**가 발생할 수 있음

즉, “Setup에서만 이동”은 결국  
- **입력 자체를 Setup에서만 허용**하거나,
- 최소한 **드롭 결과 처리(벤치/보드 소속 확정)를 Setup에서만 반영**해야 함

---

### 2) Battle 한 번 시작하면 Setup으로 돌아오는 루틴이 있나?
있음. 현재 구조는 2가지 방식으로 Setup 복귀가 가능함.

#### A) 수동 복귀(기본 흐름)
- 전투 종료 조건 만족 → `BattleState.End`
- End 상태에서 `N` 입력 → `PrepareNextRound()` 호출
- `PrepareNextRound()` 내부에서 `battleState = Setup` 복귀

#### B) 자동 복귀(옵션)
- `autoAdvanceRound = true`일 때
- 전투 종료 시 코루틴이 `PrepareNextRound()`를 지연 호출
- 입력 없이도 Setup으로 자동 복귀

정리:  
**Battle → End → (N 또는 autoAdvanceRound) → Setup** 흐름이 존재함.

---

## 오늘의 체크리스트(버그 재현/원인 파악)
### 체크 1) 전투 중에도 드래그가 되는가?
- Battle 상태에서 벤치 유닛을 클릭/드래그 시
  - 움직이면: Setup 제한이 아직 없음 → 상태 꼬임 가능성 매우 높음

### 체크 2) 벤치 유닛의 `InBattle` 값이 올바른가?
- 벤치에 있는 동안 `InBattle=false`가 유지되어야 함
- `InBattle=true`인 채로 벤치에 남으면 “벤치에서 공격” 같은 현상으로 이어질 수 있음

### 체크 3) 라운드 전환 시점에 상태 초기화가 일관적인가?
- RoundEnd 정리 후 Setup 복귀 시
  - 보드 유닛: `InBattle=true` (전투 참여 대상)
  - 벤치 유닛: `InBattle=false` (대기열)
  - 타겟/공격 상태 초기화가 꼬이면 다음 라운드에서 이상 동작 가능

### 체크 4) 드롭 실패 시 참조(슬롯/타일)가 깨지지 않는가?
- 드롭 실패 시:
  - 위치만 원복되는지
  - `BenchSlot.placedUnit` / `Tile.placedUnit` 같은 “소속 참조”가 불필요하게 변경되지 않는지
- 여기서 참조가 꼬이면 “슬롯은 비었다고 생각하는데 오브젝트는 남아있다” 같은 상태 불일치가 발생

---

## 교차검증(필수 3개)
1) 이동이 스르륵 자연스럽게 유지되는지  
2) 공격이 사거리에서 멈추지 않고 정상 발동하는지(공격 쿨다운 포함)  
3) 라운드 종료/보상/정리/다음 라운드 로그가 1회씩만 나오는지  

---

## 다음 작업 후보(내일/다음 Step)
- (버그) Setup에서만 드래그 입력 허용 / Battle에서는 입력 무시 처리
- (버그) Bench/Board 소속 확정 시 `InBattle` 및 참조(placedUnit) 일관성 강제
- (기능) 보드 ↔ 벤치 드롭(보드에서 벤치로 드롭)까지 완성해서 UX 완성도 상승

---

## 오늘 결론
- 전투 루틴(Battle→End→Setup)은 이미 존재하며 정상적으로 설계되어 있음  
- 벤치 이동 제한 문제는 “입력 허용 범위 + InBattle/참조 일관성”에서 깨질 가능성이 높음  
- 오늘은 코드 변경보다 **원인 파악 체크리스트 확정**을 우선으로 마무리

