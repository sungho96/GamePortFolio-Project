# 📅 Day 19 – Battle Flow Stabilization

## 📌 목표 (Why Day 19?)

Day 18까지 전투는 겉보기에는 정상적으로 동작했지만,  
전투 로직 관점에서는 구조적인 불안 요소가 남아 있었습니다.

- 죽은 유닛이 로직상 여전히 전투에 관여할 수 있음
- 전투 종료 판정이 프레임마다 반복될 가능성
- Unit / GridManager 간 책임이 명확하지 않음

처음에는 단순 버그처럼 보였지만,  
문제의 원인이 **전투 흐름과 책임 구조 자체**에 있다는 것을 깨닫고  
Day 19에서는 새로운 기능 추가 대신 **구조 안정화**에 집중했습니다.

👉 Day 19의 목표는  
**“전투가 돌아간다”가 아니라 “전투 흐름이 안정적으로 유지된다”**는 상태를 만드는 것이었습니다.

---

## 🧱 Day 18까지 구현된 전투 기능 (기존 기능 정리)

- 자동 전투 루프
- 가장 가까운 적 탐색
- 사거리 기준 이동 / 공격 분기
- 공격 쿨타임 기반 TickAttack
- HP 감소 및 사망 판정
- HP Bar Lerp 연출
- Damage Popup 생성 및 자동 제거
- 피격 시 Hit Flash 연출
- BattleState 기반 전투 흐름  
  - Setup → Battle → End

---

## ❗ Day 18 기준에서 발견된 문제점

### 1️⃣ 죽은 유닛 처리 문제
- HP는 0이지만 로직상 여전히 존재
- 다시 타겟으로 선택될 가능성 있음

### 2️⃣ 전투 종료 판정 불안정
- 종료 로그가 여러 번 출력될 수 있음
- 전투가 끝났는데도 UpdateBattle이 계속 실행될 가능성 있음

> 처음에는 Destroy 타이밍 문제라고 생각했지만,  
> 실제 원인은 **BattleState 분기와 전투 흐름 관리가 명확하지 않은 구조**였습니다.

### 3️⃣ 책임 분산
- Unit과 GridManager가 모두 “죽음”을 판단
- Destroy 타이밍이 상황마다 달라짐

---

## ✅ Day 19에서 한 핵심 작업

### 1️⃣ 전투 책임 분리 (Responsibility Separation)

**Unit**
- 자신의 상태 관리만 담당  
  - HP  
  - IsDead()  
  - 피격 연출 요청
- Destroy 직접 호출하지 않음
- 전투 종료 판단하지 않음

**GridManager**
- 전투 흐름 전담  
  - UpdateBattle  
  - CleanupDeadUnits  
  - CheckBattleEnd  

---

### 2️⃣ 죽은 유닛 처리 안정화

- 사망 처리는 `CleanupDeadUnits(List<Unit>)`에서만 수행
- 사망 연출(UnitDeathEffect) 중복 실행 방지
- 잘못된 `return` 사용으로 인한 루프 중단 버그 수정  
  - return → continue

👉 여러 유닛이 동시에 사망해도 정상적으로 처리됨

---

### 3️⃣ 전투 종료 조건 명확화

- 매 프레임 새로 검색하지 않고  
  이미 수집된 units 리스트 기준으로 판정
- 한 팀이라도 전멸 시  
  - BattleState를 End로 전환  
  - 결과 로그 1회만 출력  

---

### 4️⃣ BattleState 흐름 고정

- 전투 흐름은 다음 상태로만 진행됨  
  - Setup → Battle → End
- Battle 상태에서만 UpdateBattle 실행
- End 상태에서는 전투 로직 완전히 정지
- 상태가 섞이지 않도록 분기 구조 정리

---

## 🧪 Day 19 완료 기준 (검증 포인트)

- [x] 죽은 유닛이 다시 공격하지 않음
- [x] 죽은 유닛이 타겟으로 선택되지 않음
- [x] 전투 종료 로그가 한 번만 출력됨
- [x] 전투 종료 후 UpdateBattle이 실행되지 않음
- [x] Unit이 Destroy를 직접 호출하지 않음

---

## 📈 결과 요약

Day 19를 통해 전투 시스템은  

- 기능적으로 **“돌아가는 상태”**에서  
- 구조적으로 **“안정적인 상태”**로 전환되었습니다.

이 작업을 하면서  
**“전투가 된다 ≠ 전투 구조가 맞다”**는 점을 확실히 체감했습니다.

이제 이후 단계(Day 20~)에서  
이동 보정, 타겟 고정, 전투 가독성 개선 같은 작업을  
안전하게 추가할 수 있는 기반이 마련되었습니다.
